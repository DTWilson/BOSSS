---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# BOSSS <img src="man/figures/logo.png" align="right" height="139" alt="" />

<!-- badges: start -->
  [![R-CMD-check](https://github.com/DTWilson/BOSSS/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/DTWilson/BOSSS/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of BOSSS is to help people use Bayesian optimisation to solve sample size determination problems when simulation is required to calculate operating characteristics.

## Installation

Install the released version of tout from CRAN:

``` r
install.packages("BOSSS")
```

Or you can install the development version of BOSSS from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("DTWilson/BOSSS")
```

## Example

Suppose we want to design a cluster-randomised controlled trial (cRCT) which will compare the mean outcomes of two groups. We need to choose per-arm number of clusters, $m$, and the number of participants in each cluster, $n$. We would like to choose a design that jointly minimises the total numbers of both clusters and participants whilst ensuring the trial has 80% power to detect the target difference.

Suppose that there is no analytic power function for this problem, and that we need to use simulation to estimate power instead. This can make the search process very slow and unwieldy. BOSSS helps by using Bayesian optimisation to carefully choose a design to evaluate at each iteration, aiming for those that will give the most improvement over the best designs found so far.

Key features:

- Trial design spaces can have several dimensions.
- Multiple objectives are handled in a non-scalarising way.
- Design optimisation problems can be constrained by deterministic or stochastic funstion.

The output of applying BOSSS to this problem is a set solutions which satisfy the power constraint and offer a range of trade-offs between the different objectives we are minimising (here, $n$ and $k$). For example, consider the following `BOSSS_solution` object which resulted from applying the BOSSS algorithm:

```{r, include = FALSE, eval = FALSE}
library(BOSSS)

sim_cRCT <- function(m = 10, n = 20, 
                     beta_1 = 0.3, var_e = 0.95, var_u = 0.05){
  
  m <- floor(m); n <- floor(n)
  
  x <- rep(c(0,1), each = m) 
  y <- rnorm(2*m, 0, sqrt(var_u + var_e/n))
  y <- y + x*beta_1

  s <- t.test(y[x==1], y[x==0], alternative = "greater")$p.value > 0.025

  return(c(s = s))
}

det_cRCT <- function(m = 10, n = 5, 
                     beta_1 = 0.3, var_e = 0.95, var_u = 0.05)
{
  return(c(m = m, N = n*m))
}  

design_space <- design_space(lower = c(5, 5), 
                             upper = c(50, 40),
                             sim = sim_cRCT)

hypotheses <- hypotheses(values = matrix(c(0.3, 0.95, 0.05), ncol = 1),
                         hyp_names = c("alt"),
                         sim = sim_cRCT)

constraints <- constraints(name = c("con_tII"),
                   out = c("s"),
                   hyp = c("alt"),
                   nom = c(0.2),
                   delta = c(0.95),
                   binary = c(TRUE))

objectives <- objectives(name = c("N", "m"),
                 out = c("N", "m"),
                 hyp = c("alt", "alt"),
                 weight = c(1, 10),
                 binary = c(FALSE, FALSE))

problem <- BOSSS_problem(sim_cRCT, design_space, hypotheses, objectives, constraints, det_func = det_cRCT)

set.seed(9823579)

size <- 20
N <- 10^3

solution <- BOSSS_solution(size, N, problem)

for(i in 1:20){
  solution <- iterate(solution, problem, N)
}
```

```{r, include = FALSE}
library(here)
p <- here("vignettes", "example_files", "README_sol.rds")
#saveRDS(solution, p)
solution <- readRDS(p)
```

```{r}
print(solution)
```

We have sixteen designs to choose from. For example, the final design in the set involves 288 patients and 28 clusters in each arm. The estimated power for that design is $1 - 1/(1 + \exp(1.535920)) = 0.82$.

We can visualise the trade-offs between the two objectives by plotting the solution:

```{r}
plot(solution)
```

For a detailed walkthrough of how to specify and solve a problems with BOSSS, see the "Getting started" tab. Other applications are collected in the "Examples" article. 
